#!/bin/bash
set -e

# 1. [span_2](start_span)Disable ufw[span_2](end_span)
echo "[*] Disabling UFW..."
sudo ufw disable
[span_3](start_span)if systemctl is-active --quiet ufw;[span_3](end_span)
then
    [span_4](start_span)sudo systemctl stop ufw[span_4](end_span)
fi
[span_5](start_span)sudo systemctl disable ufw ||[span_5](end_span)
[span_6](start_span)true[span_6](end_span)

# 2. [span_7](start_span)Disable systemd-resolved[span_7](end_span)
echo "[*] Disabling systemd-resolved..."
[span_8](start_span)if systemctl is-active --quiet systemd-resolved;[span_8](end_span)
then
    [span_9](start_span)sudo systemctl stop systemd-resolved[span_9](end_span)
fi
[span_10](start_span)sudo systemctl disable systemd-resolved ||[span_10](end_span)
[span_11](start_span)true[span_11](end_span)

# 3. [span_12](start_span)Delete /etc/resolv.conf symlink[span_12](end_span)
if [ -L /etc/resolv.conf ]; then
    echo "[*] Removing resolv.conf symlink..."
    sudo rm -f /etc/resolv.conf
fi

# 4. [span_13](start_span)Create new /etc/resolv.conf with Google DNS[span_13](end_span)
echo "[*] Creating new resolv.conf with Google DNS..."
cat <<EOF |
[span_14](start_span)sudo tee /etc/resolv.conf[span_14](end_span)
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF

# 5. [span_15](start_span)Download binary kutoka GitHub yako[span_15](end_span)
echo "[*] Downloading halodnstt kutoka GitHub..."
TMPFILE=$(mktemp)
# [span_16](start_span)Link yako mpya imewekwa hapa chini[span_16](end_span)
curl -fsSL -o "$TMPFILE" https://raw.githubusercontent.com/Libe99/dns-tunnel/main/halodnstt
chmod +x "$TMPFILE"
sudo mv "$TMPFILE" /usr/bin/dnsttloc

# 6. [span_17](start_span)Prompt user to enter nameserver[span_17](end_span)
read -rp "Enter nameserver: " NAMESERVER

# 7. [span_18](start_span)Create systemd service for dnsttloc[span_18](end_span)
echo "[*] Creating systemd service for dnsttloc..."
SERVICE_FILE="/etc/systemd/system/dnsttloc.service"

sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=DNS Tunnel (dnsttloc)
After=network.target

[Service]
ExecStart=/usr/bin/dnsttloc -udp :53 -mtu 1800 -privkey 4cdaf264978c5fd93e6375ef7a7bee505e2a4f5234e4efc1cafb735acc11dc98 \$NAMESERVER 127.0.0.1:22
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

sudo systemctl daemon-reload
sudo systemctl enable dnsttloc.service
sudo systemctl start dnsttloc.service

# 8. [span_19](start_span)Add cronjob for scheduled reboot[span_19](end_span)
echo "[*] Adding daily reboot cron job..."
CRON_TEMP=$(mktemp)
[span_20](start_span)crontab -l 2>/dev/null > "$CRON_TEMP" ||[span_20](end_span)
[span_21](start_span)true[span_21](end_span)

sed -i '/\/sbin\/reboot/d' "$CRON_TEMP"

cat <<EOF >> "$CRON_TEMP"
0 2 * * * /sbin/reboot
EOF

crontab "$CRON_TEMP"
rm "$CRON_TEMP"

echo "[*] Setup complete!"
[span_22](start_span)echo "You can manage the service with: sudo systemctl status|stop|restart dnsttloc"[span_22](end_span)
