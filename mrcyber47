#!/bin/bash
set -e

# 1. Disable ufw
echo "[*] Disabling UFW..."
[span_0](start_span)sudo ufw disable[span_0](end_span)
[span_1](start_span)if systemctl is-active --quiet ufw;[span_1](end_span)
then
    [span_2](start_span)sudo systemctl stop ufw[span_2](end_span)
fi
[span_3](start_span)sudo systemctl disable ufw ||[span_3](end_span)
[span_4](start_span)true[span_4](end_span)

# 2. Disable systemd-resolved
echo "[*] Disabling systemd-resolved..."
[span_5](start_span)if systemctl is-active --quiet systemd-resolved;[span_5](end_span)
then
    [span_6](start_span)sudo systemctl stop systemd-resolved[span_6](end_span)
fi
[span_7](start_span)sudo systemctl disable systemd-resolved ||[span_7](end_span)
[span_8](start_span)true[span_8](end_span)

# 3. Delete /etc/resolv.conf symlink
[span_9](start_span)if [ -L /etc/resolv.conf ]; then[span_9](end_span)
    echo "[*] Removing resolv.conf symlink..."
    sudo rm -f /etc/resolv.conf
fi

# 4. Create new /etc/resolv.conf with Google DNS
echo "[*] Creating new resolv.conf with Google DNS..."
[span_10](start_span)cat <<EOF |[span_10](end_span)
[span_11](start_span)sudo tee /etc/resolv.conf[span_11](end_span)
nameserver 8.8.8.8
nameserver 8.8.4.4
EOF

# 5. Download binary, make executable, move to /usr/bin
echo "[*] Downloading halodnstt..."
[span_12](start_span)TMPFILE=$(mktemp)[span_12](end_span)
curl -fsSL -o "$TMPFILE" https://raw.githubusercontent.com/Libe99/dns-tunnel/main/mrcyber47
chmod +x "$TMPFILE"
sudo mv "$TMPFILE" /usr/bin/dnsttloc

# 6. Prompt user to enter nameserver
[span_13](start_span)read -rp "Enter nameserver: " NAMESERVER[span_13](end_span)

# 7. Create systemd service for dnsttloc
echo "[*] Creating systemd service for dnsttloc..."
[span_14](start_span)SERVICE_FILE="/etc/systemd/system/dnsttloc.service"[span_14](end_span)

sudo bash -c "cat > $SERVICE_FILE" <<EOF
[Unit]
Description=DNS Tunnel (dnsttloc)
After=network.target

[Service]
ExecStart=/usr/bin/dnsttloc -udp :53 -mtu 1800 -privkey 4cdaf264978c5fd93e6375ef7a7bee505e2a4f5234e4efc1cafb735acc11dc98 \$NAMESERVER 127.0.0.1:22
Restart=always
RestartSec=5

[Install]
WantedBy=multi-user.target
EOF

[span_15](start_span)sudo systemctl daemon-reload[span_15](end_span)
sudo systemctl enable dnsttloc.service
sudo systemctl start dnsttloc.service

# 8. Still add cronjob for scheduled reboot
echo "[*] Adding daily reboot cron job..."
[span_16](start_span)CRON_TEMP=$(mktemp)[span_16](end_span)
[span_17](start_span)crontab -l 2>/dev/null > "$CRON_TEMP" ||[span_17](end_span)
[span_18](start_span)true[span_18](end_span)

# Remove old reboot entries to avoid duplicates
[span_19](start_span)sed -i '/\/sbin\/reboot/d' "$CRON_TEMP"[span_19](end_span)

cat <<EOF >> "$CRON_TEMP"
0 2 * * * /sbin/reboot
EOF

[span_20](start_span)crontab "$CRON_TEMP"[span_20](end_span)
rm "$CRON_TEMP"

echo "[*] Setup complete!"
[span_21](start_span)echo "You can manage the service with: sudo systemctl status|stop|restart dnsttloc"[span_21](end_span)
